<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- For Collapsible Bootstrap Navbar -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  <!-- imports for navbar ends -->
  <link href="https://fonts.googleapis.com/css?family=Montserrat&display=swap" rel="stylesheet">

  <title>Todo</title>

  <style>
    body{
      background: rgb(37, 99, 56);
      background: linear-gradient(90deg, rgb(16, 22, 109) 0%, rgb(40, 32, 152) 43%, rgb(119, 143, 211) 100%);
    }

    #task-container{
		  max-width:600px;
		  margin:0 auto;
		  box-shadow: 0 14px 28px rgba(0,0,0,0.25), 0 10px 10px rgba(0,0,0,0.22);
		  background-color: #fff;
		  
		  margin-top:100px;
		  margin-bottom:100px;

		  justify-content: space-around;
		  align-items: flex-start;

		}

		#form-wrapper{
		  position: -webkit-sticky;
		  position: sticky;
		  top: 0rem;
		  border-bottom: 1px solid  #e9e9e9;
		  background-color: #fff;
		  box-shadow: 0 3px 8px rgba(0,0,0,0.25);
 		  padding:40px;
		}

		#submit{
		  background-color: #36d9b6;
		  border-radius: 0;
		  border:0;
		  color: #fff;
		}

		.flex-wrapper{
			display: flex;
		}

		.task-wrapper{
		  	margin:5px;
		  	padding: 5px;
		  	padding:20px;
		  	cursor: pointer;
		  	border-bottom: 1px solid  #e9e9e9;
		  	color: #686868;
			}

  </style>

</head>
<body>


  <!-- Navbar begins ******************************************************** -->
  <nav class="navbar navbar-inverse">
    <div class="container-fluid">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>                        
        </button>
        <a class="navbar-brand" href="#">Todo App (with Django Rest API)</a>
      </div>
      <div class="collapse navbar-collapse" id="myNavbar">
        <ul class="nav navbar-nav">
          <li class="active"><a href="#">Home</a></li>
          <li><a href="https://github.com/santoshrajkumar/Django-REST-API-for-todo-app-with-CRUD-using-Serializers-">Github Repo</a></li>
          <li><a href="https://www.santoshrajkumar.com">My Homepage</a></li>
        </ul>
      </div>
    </div>
  </nav>
    

    <!-- Navbar ends here ************************************************ -->


  <div class="container">

		<div id="task-container">
			<div id="form-wrapper">
				<form id="form">
					<div class="flex-wrapper">
						<div style="flex: 6">
							<input id="title" class="form-control" type="text" name="title" placeholder="Add task">
						</div>
						<div style="flex: 1">
							<input id="submit" class="btn" type="submit" >
						</div>
					</div>
				</form>
			</div>

			<div id="list-wrapper">
			
			</div>	
	</div>


<script type="text/javascript">

function getCookie(name) {
		    var cookieValue = null;
		    if (document.cookie && document.cookie !== '') {
		        var cookies = document.cookie.split(';');
		        for (var i = 0; i < cookies.length; i++) {
		            var cookie = cookies[i].trim();
		            // Does this cookie string begin with the name we want?
		            if (cookie.substring(0, name.length + 1) === (name + '=')) {
		                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
		                break;
		            }
		        }
		    }
		    return cookieValue;
		}
var csrftoken = getCookie('csrftoken');
// Only to generate csrf toke ^^^
var activeItem = null
    


  buildList()

  function buildList(){
    var wrapper = document.getElementById('list-wrapper')
    wrapper.innerHTML = ''

    var url = 'https://smrtodorest.herokuapp.com/api/task-list/'

    fetch(url)
    .then((resp) => resp.json())
    .then(function(data){
      console.log('Data:', data)

      var list = data

      for (var i in list){
        var title = `<span class="title">${list[i].title}</span>`
        if (list[i].completed == true){
          title = `<strike class="title">${list[i].title}</strike>`
        }

        var item = `
						<div id="data-row-${i}" class="task-wrapper flex-wrapper">
							<div style="flex:7">
								${title}
							</div>
							<div style="flex:1">
								<button class="btn btn-sm btn-outline-info edit">Edit </button>
							</div>
							<div style="flex:1">
								<button class="btn btn-sm btn-outline-dark delete">-</button>
							</div>
						</div>
          `
        wrapper.innerHTML += item
       
      }

      for (var i in list){

        var editBtn = document.getElementsByClassName('edit')[i]
        var deleteBtn = document.getElementsByClassName('delete')[i]
        var title = document.getElementsByClassName('title')[i]

        editBtn.addEventListener('click', (function(item){
          return function(){
            editItem(item)
          }
        })(list[i]))

       deleteBtn.addEventListener('click', (function(item){
          return function(){
            deleteItem(item)
          }
        })(list[i]))

       title.addEventListener('click', (function(item){
          return function(){
            strikeUnstrike(item)
          }
        })(list[i]))

      }

    })
  }


  var form = document.getElementById('form-wrapper')
  form.addEventListener('submit', function(e){
    e.preventDefault()
    var url = 'https://smrtodorest.herokuapp.com/api/task-create/'

    if (activeItem != null){
      var url = `https://smrtodorest.herokuapp.com/api/task-update/${activeItem.id}/`
      activeItem = null
    }




    var title = document.getElementById('title').value

    fetch(url, {
      method: 'POST',
      headers:{
        'Content-type':'application/json',
        'X-CSRFToken': csrftoken,
      },

      body:JSON.stringify({'title':title})

    } 
    ).then(function(response){
      buildList()
      document.getElementById('form').reset()
    })


  })


  function editItem(item){

    console.log('Edit item ' , item)
    activeItem = item
    document.getElementById('title').value = activeItem.title
  }

  function deleteItem(item){
    console.log('delete item', item)
    var url = `https://smrtodorest.herokuapp.com/api/task-delete/${item.id}/`
    fetch(url, {
      method: 'DELETE',
      headers:{
        'Content-type':'application/json',
        'X-CSRFToken': csrftoken,
      }
    }).then((response) => {
      buildList()
    })

  }

  function strikeUnstrike(item){
    console.log('strike', item)
    item.completed = !item.completed
    var url = `https://smrtodorest.herokuapp.com/api/task-update/${item.id}/`
    fetch(url, {
      method: 'POST',
      headers:{
        'Content-type':'application/json',
        'X-CSRFToken': csrftoken,
      },
      body:JSON.stringify({'title':item.title, 'completed':item.completed})
    }).then((response) => {
      buildList()
    })

  }


</script>
  
  
</body>
</html>